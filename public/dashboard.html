<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mahalle Risk Analiz Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;background:#f8fafc;color:#1e293b;overflow:hidden}
    .app{display:flex;flex-direction:column;height:100vh}
    .header{background:linear-gradient(135deg,#667eea 0%, #764ba2 100%);color:#fff;padding:14px 22px;box-shadow:0 4px 16px rgba(0,0,0,.15)}
    .header h1{font-size:20px;font-weight:700}
    .header small{opacity:.9}
    .content{display:flex;flex:1;overflow:hidden}
    .panel{width:360px;background:#fff;border-right:1px solid #e5e7eb;overflow:auto;padding:18px}
    .sec{margin-bottom:18px;padding-bottom:14px;border-bottom:1px solid #e5e7eb}
    .sec h3{font-size:14px;margin-bottom:10px;display:flex;gap:8px;align-items:center}
    .btnrow{display:flex;gap:8px}
    .btn{flex:1;padding:10px;border:2px solid #e5e7eb;border-radius:10px;background:#fff;cursor:pointer;font-weight:600}
    .btn.active{background:#667eea;border-color:#667eea;color:#fff}
    .select,.input{width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:10px}
    .legend{display:flex;flex-direction:column;gap:6px}
    .legend-item{display:flex;align-items:center;gap:10px}
    .legend-swatch{width:28px;height:18px;border:2px solid #555;border-radius:4px}
    .cards{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .card{padding:12px;text-align:center;border:1px solid #e5e7eb;border-radius:10px;background:#f9fafb}
    .card .v{font-weight:700;color:#667eea;font-size:18px}
    .tabs{display:flex;background:#fff;border-bottom:2px solid #e5e7eb;padding:0 18px}
    .tab{padding:14px 18px;border:none;background:none;cursor:pointer;font-weight:700;color:#6b7280;border-bottom:3px solid transparent}
    .tab.active{color:#667eea;border-bottom-color:#667eea}
    .view{display:none;flex:1}
    .view.active{display:flex;flex-direction:column}
    #map{width:100%;height:100%}
    .controls{padding:14px 18px;border-bottom:2px solid #e5e7eb;background:#fff}
    .ctrlrow{display:flex;gap:14px;align-items:end}
    .ctrl{flex:1}
    .chartwrap{flex:1;overflow:auto;background:#fff;padding:18px}
    .loading{position:fixed;inset:0;background:rgba(255,255,255,.96);display:flex;align-items:center;justify-content:center;z-index:9999}
    .box{background:#fff;padding:22px;border-radius:12px;box-shadow:0 18px 60px rgba(0,0,0,.25);text-align:center}
    .spinner{width:58px;height:58px;border:5px solid #e5e7eb;border-top:5px solid #667eea;border-radius:50%;margin:0 auto 12px;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .note{font-size:12px;color:#64748b;margin-top:6px}
  </style>
</head>
<body>
<div id="loading" class="loading">
  <div class="box"><div class="spinner"></div><div id="loadtxt">Yükleniyor…</div></div>
</div>

<div class="app">
  <div class="header">
    <h1>Mahalle Risk Analiz Dashboard</h1>
    <small>İstanbul & Ankara – Choropleth, VS30, Scatter, Korelasyon</small>
  </div>

  <div class="content">
    <!-- LEFT PANEL -->
    <aside class="panel">
      <div class="sec">
        <h3><i class="fa-solid fa-city"></i> Şehir Seçimi</h3>
        <div class="btnrow">
          <button id="btnCityIST" class="btn active" onclick="selectCity('istanbul')">İSTANBUL</button>
          <button id="btnCityANK" class="btn" onclick="selectCity('ankara')">ANKARA</button>
        </div>
      </div>

      <div class="sec">
        <h3><i class="fa-solid fa-eye"></i> Görünüm</h3>
        <div class="btnrow">
          <button id="viewAll" class="btn active" onclick="switchView('all')">TÜM</button>
          <button id="viewIst" class="btn" onclick="switchView('istanbul')">İST</button>
          <button id="viewAnk" class="btn" onclick="switchView('ankara')">ANK</button>
        </div>
      </div>

      <div class="sec">
        <h3><i class="fa-solid fa-magnifying-glass"></i> <span id="cityLabel">İstanbul</span> Mahallesi</h3>
        <select id="mahSelect" class="select" onchange="selectMahalle()">
          <option value="">-- Mahalle Seçiniz --</option>
        </select>
        <div class="note" id="mahInfo" style="display:none;margin-top:8px"></div>
      </div>

      <div class="sec">
        <h3><i class="fa-solid fa-gears"></i> Görselleştirme Değişkeni</h3>
        <select id="choroVar" class="select" onchange="updateChoropleth()">
          <option value="risk_class_5">Risk Sınıfı (1–5)</option>
          <option value="risk_score">Risk Skoru</option>
          <option value="vs30_mean">VS30 Ortalama</option>
          <option value="pga_scenario_mw75">PGA (Mw7.5)</option>
          <option value="toplam_nufus">Toplam Nüfus</option>
          <option value="toplam_bina">Toplam Bina</option>
        </select>
        <div class="note" id="varNote">Seçili: Risk Sınıfı</div>
      </div>

      <div class="sec">
        <h3><i class="fa-solid fa-palette"></i> Legend</h3>
        <div id="legend" class="legend"></div>
      </div>

      <div class="sec">
        <h3><i class="fa-solid fa-chart-simple"></i> İstatistikler</h3>
        <div class="cards">
          <div class="card"><div class="v" id="statTotal">0</div><div>Toplam Mahalle</div></div>
          <div class="card"><div class="v" id="statAvg">0</div><div>Ort. Risk</div></div>
          <div class="card"><div class="v" id="statHigh">0</div><div>Yüksek Risk</div></div>
        </div>
      </div>
    </aside>

    <!-- RIGHT: MAP + CHARTS -->
    <section style="flex:1;display:flex;flex-direction:column;">
      <div class="tabs">
        <button class="tab active" id="tab-map" onclick="switchTab('map')">Choropleth Harita</button>
        <button class="tab" id="tab-scatter" onclick="switchTab('scatter')">Scatter Analizi</button>
        <button class="tab" id="tab-corr" onclick="switchTab('corr')">Korelasyon</button>
        <button class="tab" id="tab-dist" onclick="switchTab('dist')">Dağılım</button>
      </div>

      <!-- MAP -->
      <div class="view active" id="view-map">
        <div id="map"></div>
      </div>

      <!-- SCATTER -->
      <div class="view" id="view-scatter">
        <div class="controls">
          <div class="ctrlrow">
            <div class="ctrl">
              <label>X Ekseni</label>
              <select id="sx" class="select" onchange="updateScatter()">
                <option value="vs30_mean">VS30</option>
                <option value="toplam_nufus">Nüfus</option>
                <option value="toplam_bina">Bina</option>
                <option value="pga_scenario_mw75">PGA</option>
              </select>
            </div>
            <div class="ctrl">
              <label>Y Ekseni</label>
              <select id="sy" class="select" onchange="updateScatter()">
                <option value="risk_score">Risk Skoru</option>
                <option value="combined_risk_index">Combined Risk</option>
              </select>
            </div>
            <div class="ctrl">
              <label>Renk</label>
              <select id="sc" class="select" onchange="updateScatter()">
                <option value="risk_class_5">Risk Sınıfı</option>
                <option value="ilce_adi">İlçe</option>
              </select>
            </div>
          </div>
        </div>
        <div class="chartwrap"><canvas id="scatter"></canvas></div>
      </div>

      <!-- CORR -->
      <div class="view" id="view-corr">
        <div class="chartwrap"><canvas id="corr"></canvas></div>
      </div>

      <!-- DIST -->
      <div class="view" id="view-dist">
        <div class="controls">
          <div class="ctrlrow">
            <div class="ctrl">
              <label>Değişken</label>
              <select id="dv" class="select" onchange="updateDist()">
                <option value="risk_class_5">Risk Sınıfı</option>
                <option value="ilce_adi">İlçe</option>
                <option value="vs30_mean">VS30</option>
                <option value="toplam_nufus">Nüfus</option>
              </select>
            </div>
          </div>
        </div>
        <div class="chartwrap"><canvas id="dist"></canvas></div>
      </div>
    </section>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // -------- STATE
  let map, view='all', city='istanbul';
  const cityData = { istanbul:{gj:null, layer:null, loaded:false}, ankara:{gj:null, layer:null, loaded:false} };
  const riskColors={1:'#2ECC71',2:'#F1C40F',3:'#E67E22',4:'#E74C3C',5:'#8E44AD'};
  const riskLabels={1:'Çok Düşük',2:'Düşük',3:'Orta',4:'Yüksek',5:'Çok Yüksek'};
  let choroVar='risk_class_5';

  // -------- INIT
  (async function init(){
    setLoad('Harita başlatılıyor…'); initMap();
    setLoad('İstanbul verileri yükleniyor…'); await loadCity('istanbul','/data/istanbul_mahalle_risk.geojson');
    setLoad('Ankara verileri yükleniyor…');   await loadCity('ankara','/data/ankara_mahalle_risk.geojson');
    buildMahList(); draw(); updateStats(); renderLegend(); initCharts(); hideLoad();
  })();

  function setLoad(t){ document.getElementById('loadtxt').textContent=t; }
  function hideLoad(){ document.getElementById('loading').style.display='none'; }

  // -------- MAP
  function initMap(){
    map = L.map('map').setView([39.9,32.8],6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap'}).addTo(map);
  }

  async function loadCity(key,url){
    try{
      const r = await fetch(url); if(!r.ok) throw new Error(url+' bulunamadı');
      const gj = await r.json();
      (gj.features||[]).forEach(f=>{ f.properties=f.properties||{}; f.properties.city=key; });
      cityData[key].gj = gj; cityData[key].loaded = true;
    }catch(e){
      console.warn(key,'yüklenemedi:',e.message); cityData[key].gj={type:'FeatureCollection',features:[]};
    }
  }

  function draw(){
    // temizle
    Object.values(cityData).forEach(c=>{ if(c.layer){ map.removeLayer(c.layer); c.layer=null; } });

    const keys = (view==='all') ? ['istanbul','ankara'] : [view];
    keys.forEach(k=>{
      const gj = cityData[k].gj; if(!gj) return;
      cityData[k].layer = L.geoJSON(gj,{
        // SADECE POLİGONLARI çiz (OSM nokta/çizgi pinleri görünmesin)
        filter: f => ['Polygon','MultiPolygon'].includes(f.geometry?.type),
        style: f => {
          const color = colorForFeature(f);
          return {fillColor:color, color:'#555', weight:1, opacity:1, fillOpacity:.7};
        },
        onEachFeature:(f,layer)=>{
          layer.on({
            mouseover:e=>{e.target.setStyle({weight:3,color:'#000',fillOpacity:.9});e.target.bringToFront();},
            mouseout:e=>{cityData[k].layer.resetStyle(e.target);},
            click:e=>popup(f,e.latlng)
          });
        }
      }).addTo(map);
    });

    // fit
    const allCoords=[];
    keys.forEach(k=>{
      const gj=cityData[k].gj;
      (gj.features||[]).forEach(f=>{
        const g=f.geometry||{};
        if(g.type==='Polygon'){
          g.coordinates.flat(1).forEach(c=>allCoords.push(c));
        }
        if(g.type==='MultiPolygon'){
          g.coordinates.flat(2).forEach(c=>allCoords.push(c));
        }
      });
    });
    if(allCoords.length){
      let minX=Infinity, maxX=-Infinity, minY=Infinity, maxY=-Infinity;
      allCoords.forEach(c=>{
        if(c[0]<minX) minX=c[0]; if(c[0]>maxX) maxX=c[0];
        if(c[1]<minY) minY=c[1]; if(c[1]>maxY) maxY=c[1];
      });
      map.fitBounds([[minY,minX],[maxY,maxX]],{padding:[30,30]});
    }
  }

  function colorForFeature(f){
    const p=f.properties||{};
    if(choroVar==='risk_class_5'){
      const rc = getRiskClass(p);
      return riskColors[rc]||'#cccccc';
    }
    // ardışık renkler (sequential)
    const vals = [];
    ['istanbul','ankara'].forEach(k=>{
      (cityData[k].gj.features||[]).forEach(ft=>{
        const v = num(ft.properties[choroVar]); if(Number.isFinite(v)) vals.push(v);
      });
    });
    if(!vals.length) return '#cccccc';
    const v = num(p[choroVar]); if(!Number.isFinite(v)) return '#cccccc';
    const min=Math.min(...vals), max=Math.max(...vals), t=(v-min)/((max-min)||1);
    const palette=['#f0f9ff','#bae6fd','#7dd3fc','#38bdf8','#0ea5e9','#0284c7'];
    const i=Math.max(0,Math.min(palette.length-1, Math.floor(t*(palette.length-1))));
    return palette[i];
  }

  function popup(f, latlng){
    const p=f.properties||{};
    const name = p.mahalle_adi||p.Name||p.name||'Mahalle';
    const ilce = p.ilce_adi||p.district||'—';
    const rc = getRiskClass(p);
    const riskScore = normalizedRisk(p);
    const vs30 = p.vs30_mean ?? p.vs30;
    const pga  = p.pga_scenario_mw75 ?? p.pga_total_scenario ?? p.pga_scenario_mw72;

    let html = `<div style="min-width:220px;font:12px/1.4 Inter,system-ui,sans-serif">
      <div style="font-weight:700;margin-bottom:6px">${name}</div>
      <div>İlçe: <b>${ilce}</b></div>
      <div style="margin:6px 0;padding:8px;border-radius:6px;color:#fff;background:${riskColors[rc]||'#999'}">
        Risk Sınıfı: <b>${rc||'-'}</b> ${riskLabels[rc]?' - '+riskLabels[rc]:''}
      </div>
      <div>Risk Skoru: <b>${riskScore!=null?riskScore.toFixed(2):'-'}</b></div>
      ${vs30!=null?`<div>VS30: <b>${Number(vs30).toFixed(0)}</b> m/s</div>`:''}
      ${pga!=null?`<div>PGA (Mw7.5): <b>${Number(pga).toFixed(4)}</b> g</div>`:''}
    </div>`;
    L.popup().setLatLng(latlng).setContent(html).openOn(map);
  }

  function getRiskClass(p){
    return Number(p.risk_class_5 ?? p.risk_label_5li ?? p.risk_label_normalized ?? 0) || 0;
  }
  function normalizedRisk(p){
    if(p.combined_risk_index!=null) return Number(p.combined_risk_index);
    if(p.risk_score!=null) return Number(p.risk_score);
    if(p.bilesik_risk_skoru!=null){ const v=Number(p.bilesik_risk_skoru); return v>1?v:(v*100); }
    return null;
  }
  const num = v => (v==null?NaN:Number(v));

  // -------- UI
  function selectCity(k){
    city=k;
    document.getElementById('btnCityIST').classList.toggle('active',k==='istanbul');
    document.getElementById('btnCityANK').classList.toggle('active',k==='ankara');
    document.getElementById('cityLabel').textContent=k==='istanbul'?'İstanbul':'Ankara';
    buildMahList();
  }
  function switchView(v){
    view=v;
    document.getElementById('viewAll').classList.toggle('active',v==='all');
    document.getElementById('viewIst').classList.toggle('active',v==='istanbul');
    document.getElementById('viewAnk').classList.toggle('active',v==='ankara');
    draw(); updateStats(); renderLegend();
  }
  function buildMahList(){
    const list = (cityData[city].gj.features||[]).map(f=>{
      const p=f.properties||{}; return {name:p.mahalle_adi||p.Name||p.name||'Mahalle', ilce:p.ilce_adi||p.district||'', f};
    }).sort((a,b)=>a.name.localeCompare(b.name,'tr'));
    const sel=document.getElementById('mahSelect'); sel.innerHTML='<option value="">-- Mahalle Seçiniz --</option>';
    list.forEach((m,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=`${m.name} (${m.ilce})`; sel.appendChild(o); });
    sel.dataset.count = list.length;
    sel.dataset.city = city;
    sel._data = list;
  }
  function selectMahalle(){
    const sel=document.getElementById('mahSelect');
    if(sel.value===''){ document.getElementById('mahInfo').style.display='none'; return; }
    const m = sel._data[Number(sel.value)];
    document.getElementById('mahInfo').style.display='block';
    document.getElementById('mahInfo').innerHTML = `<b>${m.name}</b> – ${m.ilce}`;
    // zoom
    const g=m.f.geometry;
    let bounds;
    if(g.type==='Polygon'){ const ll=g.coordinates[0].map(c=>[c[1],c[0]]); bounds=L.latLngBounds(ll); }
    if(g.type==='MultiPolygon'){ const ll=g.coordinates.flat(1)[0].map(c=>[c[1],c[0]]); bounds=L.latLngBounds(ll); }
    if(bounds) map.fitBounds(bounds,{padding:[60,60]});
  }
  function updateChoropleth(){
    choroVar=document.getElementById('choroVar').value;
    const labels={
      risk_class_5:'Risk Sınıfı', risk_score:'Risk Skoru',
      vs30_mean:'VS30 Ortalama', pga_scenario_mw75:'PGA (Mw7.5)',
      toplam_nufus:'Nüfus', toplam_bina:'Bina'
    };
    document.getElementById('varNote').textContent='Seçili: '+(labels[choroVar]||choroVar);
    draw(); renderLegend();
  }

  function renderLegend(){
    const wrap=document.getElementById('legend'); wrap.innerHTML='';
    if(choroVar==='risk_class_5'){
      for(let i=1;i<=5;i++){
        const row=document.createElement('div'); row.className='legend-item';
        row.innerHTML=`<div class="legend-swatch" style="background:${riskColors[i]}"></div><div>Sınıf ${i} – ${riskLabels[i]}</div>`;
        wrap.appendChild(row);
      }
    }else{
      const row=document.createElement('div'); row.className='legend-item';
      row.innerHTML=`<div class="legend-swatch" style="background:#f0f9ff"></div><div> düşük</div>`;
      wrap.appendChild(row);
      const row2=document.createElement('div'); row2.className='legend-item';
      row2.innerHTML=`<div class="legend-swatch" style="background:#0284c7"></div><div> yüksek</div>`;
      wrap.appendChild(row2);
    }
  }

  function updateStats(){
    const feats = (view==='all')
      ? [...(cityData.istanbul.gj.features||[]), ...(cityData.ankara.gj.features||[])]
      : (cityData[view].gj.features||[]);
    const total = feats.length;
    let sum=0, cnt=0, high=0;
    feats.forEach(f=>{
      const rc = getRiskClass(f.properties||{});
      const sc = normalizedRisk(f.properties||{});
      if(rc>=4) high++;
      if(sc!=null){ sum+=Number(sc); cnt++; }
    });
    document.getElementById('statTotal').textContent=total;
    document.getElementById('statAvg').textContent= cnt? (sum/cnt).toFixed(2) : '0';
    document.getElementById('statHigh').textContent=high;
  }

  // -------- TABS + CHARTS
  function switchTab(id){
    ['map','scatter','corr','dist'].forEach(t=>{
      document.getElementById('tab-'+t).classList.toggle('active',t===id);
      document.getElementById('view-'+t).classList.toggle('active',t===id);
    });
    if(id==='scatter') updateScatter();
    if(id==='corr') updateCorr();
    if(id==='dist') updateDist();
    if(id==='map') setTimeout(()=>map.invalidateSize(),50);
  }

  let scatterChart, corrChart, distChart;
  function initCharts(){
    scatterChart = new Chart(document.getElementById('scatter').getContext('2d'), {
      type:'scatter',
      data:{datasets:[]},
      options:{responsive:true,maintainAspectRatio:false,
        plugins:{legend:{position:'top'},title:{display:true,text:'Scatter Analizi'}},
        scales:{x:{title:{display:true,text:'X'}},y:{title:{display:true,text:'Y'}}}
      }
    });
    corrChart = new Chart(document.getElementById('corr').getContext('2d'), {
      type:'bar',
      data:{labels:[],datasets:[]},
      options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',
        plugins:{legend:{display:false},title:{display:true,text:'Risk Skoru ile Korelasyon'}},
        scales:{x:{min:-1,max:1}}
      }
    });
    distChart = new Chart(document.getElementById('dist').getContext('2d'), {
      type:'bar',
      data:{labels:[],datasets:[]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},title:{display:true,text:'Dağılım'}}}
    });
  }

  function collectFeats(){
    const arr=[];
    if(view==='all'){ arr.push(...(cityData.istanbul.gj.features||[]), ...(cityData.ankara.gj.features||[])); }
    else { arr.push(...(cityData[view].gj.features||[])); }
    return arr;
  }

  function updateScatter(){
    const xk = document.getElementById('sx').value;
    const yk = document.getElementById('sy').value;
    const ck = document.getElementById('sc').value;
    const feats = collectFeats();

    const pts = feats.map(f=>{
      const p=f.properties||{};
      const x=num(p[xk]), y=num(p[yk]); const c=p[ck];
      return Number.isFinite(x)&&Number.isFinite(y) ? {x,y,c} : null;
    }).filter(Boolean);

    const datasets=[];
    if(ck==='risk_class_5'){
      for(let i=1;i<=5;i++){
        const ds = pts.filter(p=>Number(p.c)===i);
        if(ds.length) datasets.push({label:'Risk '+i, data:ds, backgroundColor:riskColors[i], pointRadius:4});
      }
    }else{
      datasets.push({label:'Veri', data:pts, backgroundColor:'#667eea', pointRadius:4});
    }
    scatterChart.data.datasets = datasets;
    scatterChart.options.scales.x.title.text = document.getElementById('sx').selectedOptions[0].text;
    scatterChart.options.scales.y.title.text = document.getElementById('sy').selectedOptions[0].text;
    scatterChart.update();
  }

  function updateCorr(){
    const feats = collectFeats();
    const risk = feats.map(f=>normalizedRisk(f.properties||{})).filter(v=>v!=null);
    const vars = [
      {k:'toplam_nufus', n:'Nüfus'},
      {k:'toplam_bina', n:'Bina'},
      {k:'vs30_mean', n:'VS30'},
      {k:'pga_scenario_mw75', n:'PGA'}
    ];
    function corr(a,b){
      const n=Math.min(a.length,b.length); if(!n) return 0;
      const ax=a.slice(0,n), bx=b.slice(0,n);
      const sa=ax.reduce((s,v)=>s+v,0), sb=bx.reduce((s,v)=>s+v,0);
      const sxy=ax.reduce((s,v,i)=>s+v*bx[i],0);
      const sxx=ax.reduce((s,v)=>s+v*v,0), syy=bx.reduce((s,v)=>s+v*v,0);
      const num=n*sxy-sa*sb, den=Math.sqrt((n*sxx-sa*sa)*(n*syy-sb*sb)); return den?num/den:0;
    }
    const results = vars.map(v=>{
      const x=feats.map(f=>num((f.properties||{})[v.k])).filter(Number.isFinite);
      return {n:v.n, c:corr(risk.slice(0,x.length), x)};
    }).sort((a,b)=>Math.abs(b.c)-Math.abs(a.c));

    corrChart.data.labels = results.map(r=>r.n);
    corrChart.data.datasets = [{label:'Korelasyon', data:results.map(r=>r.c), backgroundColor:results.map(r=>r.c>=0?'#667eea':'#e74c3c')}];
    corrChart.update();
  }

  function updateDist(){
    const key = document.getElementById('dv').value;
    const feats = collectFeats();
    let labels=[], data=[];
    if(key==='risk_class_5'){
      const c=[0,0,0,0,0];
      feats.forEach(f=>{ const rc=getRiskClass(f.properties||{}); if(rc>=1&&rc<=5) c[rc-1]++; });
      labels=['1','2','3','4','5']; data=c;
    }else if(key==='ilce_adi'){
      const map={}; feats.forEach(f=>{ const il=(f.properties||{}).ilce_adi||'—'; map[il]=(map[il]||0)+1; });
      labels=Object.keys(map); data=Object.values(map);
    }else{
      const vals=feats.map(f=>num((f.properties||{})[key])).filter(Number.isFinite);
      const n=10, min=Math.min(...vals), max=Math.max(...vals), step=(max-min)/(n||1);
      for(let i=0;i<n;i++){ const s=min+i*step, e=s+step; labels.push(`${s.toFixed(0)}-${e.toFixed(0)}`); data.push(vals.filter(v=>v>=s && v<e).length); }
    }
    distChart.data.labels=labels; distChart.data.datasets=[{label:'Sayı', data, backgroundColor:'#667eea'}];
    distChart.update();
  }
</script>
</body>
</html>
